<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.jhta.mapper.BoardMapper">

	<select id="getAllBoards1" resultType="kr.co.jhta.vo.Board">
		select 
			B.board_no					as no
			, B.board_title				as title
			, B.board_review_cnt		as reviewCnt
			, B.board_created_date		as createdDate
			, U.user_no					as "user.no"
			, U.user_id					as "user.id"
			, U.user_name				as "user.name"
		from
			tb_boards B, tb_users U
		where
			B.user_no = U.user_no
		order by
			B.board_no desc
	</select>
	
	<resultMap id="boardResultMap2" type="kr.co.jhta.vo.Board">
		<id property="no" column="BOARD_NO" />
		<result property="title" column="BOARD_TITLE" />
		<result property="reviewCnt" column="BOARD_REVIEW_CNT" />
		<result property="createdDate" column="BOARD_CREATED_DATE" />
		<association property="user" javaType="kr.co.jhta.vo.User">
			<id property="no" column="USER_NO" />
			<result property="id" column="USER_ID" />
			<result property="name" column="USER_NAME" />
		</association>
	</resultMap>
	
	<select id="getAllBoards2" resultMap="boardResultMap2">
		select 
			B.board_no					
			, B.board_title				
			, B.board_review_cnt		
			, B.board_created_date		
			, U.user_no					
			, U.user_id					
			, U.user_name				
		from
			tb_boards B, tb_users U
		where
			B.user_no = U.user_no
		order by
			B.board_no desc
	</select>
	
	<resultMap id="boardResultMap3" type="kr.co.jhta.vo.Board">
		<id property="no" column="BOARD_NO" />
		<result property="title" column="BOARD_TITLE" />
		<result property="reviewCnt" column="BOARD_REVIEW_CNT" />
		<result property="createdDate" column="BOARD_CREATED_DATE" />
		<association property="user" javaType="kr.co.jhta.vo.User" 
			column="USER_NO"
			select="kr.co.jhta.mapper.UserMapper.getUserByNo"/>
	</resultMap>
	
	<select id="getAllBoards3" resultMap="boardResultMap3">
		select 
			board_no					
			, board_title				
			, board_review_cnt		
			, board_created_date
			, user_no						
		from
			tb_boards
		order by
			board_no desc
	</select>
	
	<resultMap id="boardResultMap4" type="kr.co.jhta.vo.Board">
      <id property="no"             column="board_no" />
      <result property="title"       column="board_title" />   
      <result property="content"       column="board_content" />   
      <result property="reviewCnt"    column="board_review_cnt" />   
      <result property="reviewPoint"    column="board_review_point" />   
      <result property="createdDate"    column="board_created_date" />   
      <result property="updatedDate"    column="board_updated_date" />
      <association property="user" javaType="kr.co.jhta.vo.User">
         <id property="no"          column="user_no" />
         <result property="id"       column="user_id" />   
         <result property="name"    column="user_name" />   
      </association>
      <collection property="reviews" ofType="kr.co.jhta.vo.Review">
         <id property="no"             column="review_no" />
         <result property="title"       column="review_title" />   
         <result property="content"       column="review_content" />   
         <result property="createdDate"    column="review_created_date" />   
      </collection>   
   </resultMap>
	
	<select id="getBoardByNo" resultMap="boardResultMap4">
		select
         B.board_no
         , B.board_title
         , B.board_content
         , B.board_review_cnt
         , B.board_review_point
         , B.board_created_date
         , B.board_updated_date
         , U.user_no
         , U.user_id
         , U.user_name
         , R.review_no
         , R.review_title
         , R.review_content
         , R.review_created_date
      from
         tb_boards B, tb_users U, tb_reviews R
      where
         B.board_no = #{no}
         and B.user_no = U.user_no
         and B.board_no = R.board_no
      order by
         r.review_no asc
	</select>
	
	<!-- 

		List<Board> searchBoards1(@Param("opt") String opt
								  @Param("keyword") String keyword);
		List<Board> searchBoard(@Param("title") String title, @Param("cnt") int reviewCnt);
								  
		List<Board> boards = boardMapper.searchBoards1("title", "자바");
		List<Board> boards = boardMapper.searchBoards1("content", "스프링");
		List<Board> boards = boardMapper.searchBoards1("writer", "김유신");
	-->
	<select id="searchBoard" resultType="kr.co.jhta.vo.Board">
		select 
			board_no				as no
			, board_title			as title
			, board_content 		as content
			, board_created_date 	as createdDate
		from	
			tb_boards
		<where>
			<if test="title != null">
				board_title like '%' || #{title} || '%'
			</if>
			<if test="cnt > 0">
				and board_review_cnt > #{cnt}
			</if>
			<if test="tags != null">
				and board_no in (select board_no
								 from tb_boards_tags
								 where 
								 	<foreach index="i"
								 			 item="tag"
								 			 collection="tags"
								 			 open="board_tag in ("
								 			 separator=","
								 			 close=")">
								 		#{tag}
								 	</foreach>
								 )		
			</if>
		</where>
	</select>
	
	<select id="searchBoards1" resultType="kr.co.jhta.vo.Board">
		select 
			board_no				as no
			, board_title			as title
			, board_content 		as content
			, board_created_date 	as createdDate
		from	
			tb_boards
		where
			board_deleted = 'N'
			<choose>
				<when test="opt == 'title'">
					and 
					board_title like '%' || #{keyword} || '%'
				</when>
				<when test="opt == 'content'">
					and 
					board_content like '%' || #{keyword} || '%'
				</when>
				<when test="opt == 'writer'">
					and
					user_no in (select user_no
								from tb_users
								where user_name = #{keyword})	
				</when>
			</choose>		
	</select>
</mapper>